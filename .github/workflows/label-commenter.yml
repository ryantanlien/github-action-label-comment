name: performance-checklist

on: 
  pull_request:
    types: [labeled]

jobs:
  comment-pr:
    if: ${{ github.event.label.name == 'performance sensitive' }}
    runs-on: ubuntu-latest
    steps:
      - name: Comment Performance Checklist on PR
        uses: actions/github-script@v6
        with: 
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ github.event.pull_request.number }},
                body: "# Performance Check List \
                  This is an automated performance check list generated by GitHub Actions. \
                  \
                  You have labeled this PR as performance sensitive, and thusly a performance check must be done."
              });
              console.log('comment added')
            } catch (error) {
              console.log(error)
              console.log('comment adding failed')
            }
      - name: Block merging if performance label is added without completion label
        if: ${{ contains(github.event.pull_request.labels.*.name, 'performance sensitive') && !contains(github.event.pull_request.labels.*.name, 'performance check done') }}
        run: |
          echo "Perform the performance check! Once done, add the 'performance check done' label."
          exit 1

